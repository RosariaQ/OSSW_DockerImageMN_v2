{% extends "base.html" %}

{% block content %}
<style>
    .status-text {
        font-weight: bold;
    }
    .status-success {
        color: green;
    }
    .status-failure {
        color: red;
    }
    .status-partial_failure, .status-unknown { /* UNKNOWN 등 다른 상태도 주황색으로 처리 */
        color: orange;
    }
    /* 이전 .audit-details-summary, .audit-details-content는 삭제하거나 주석 처리 가능 */

    /* Modal Styles */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.6); /* Dim background */
    }

    .modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 25px;
        border: 1px solid #888;
        width: 75%; /* Modal width */
        max-width: 700px; /* Max width */
        border-radius: 8px;
        position: relative;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .modal-close-button {
        color: #aaa;
        float: right;
        font-size: 30px;
        font-weight: bold;
        line-height: 1;
    }

    .modal-close-button:hover,
    .modal-close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    .modal-header h3 {
        margin-top: 0;
        color: #333;
    }

    .modal-body pre {
        white-space: pre-wrap;
        word-break: break-all;
        max-height: 60vh; /* Limit height and allow scroll */
        overflow-y: auto;
        background-color: #f0f0f0; /* Light gray background for pre */
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.9em;
    }
    .view-details-btn {
        cursor: pointer;
        /* 추가적인 버튼 스타일링은 .button 클래스를 따르거나 여기에 정의 */
    }
</style>

<h2>감사 로그 조회</h2>
<p>현재 로그인한 관리자: <strong>{{ current_user }}</strong></p>

{% if error %}
    <div class="error-message">{{ error }}</div>
{% endif %}
{% if message %} {# 일반 메시지 표시 (예: 작업 성공) #}
    <div class="success-message">{{ message }}</div>
{% endif %}

<hr>

<h3>로그 필터링</h3>
<form action="{{ url_for('view_audit_logs_web_ui') }}" method="get">
    <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
        <div>
            <label for="user">사용자 이름:</label><br>
            <input type="text" id="user" name="user" value="{{ current_filters.user or '' }}">
        </div>
        <div>
            <label for="image">이미지 이름 (부분 일치):</label><br>
            <input type="text" id="image" name="image" value="{{ current_filters.image or '' }}">
        </div>
        <div>
            <label for="action">작업 유형:</label><br>
            <select id="action" name="action">
                <option value="">-- 전체 --</option>
                {% for action_opt in audit_action_options %}
                <option value="{{ action_opt }}" {% if current_filters.action == action_opt %}selected{% endif %}>
                    {{ action_opt }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="limit">표시 개수:</label><br>
            <input type="number" id="limit" name="limit" value="{{ current_filters.limit or 100 }}" min="1" max="1000">
        </div>
        <div>
            <label for="offset">오프셋:</label><br>
            <input type="number" id="offset" name="offset" value="{{ current_filters.offset or 0 }}" min="0">
        </div>
    </div>
    <div>
        <button type="submit">로그 조회</button>
        <a href="{{ url_for('view_audit_logs_web_ui') }}" class="button" style="background-color: #6c757d;">필터 초기화</a>
    </div>
</form>

<hr style="margin-top: 30px; margin-bottom: 30px;">

<h3>감사 로그 목록 (최신순)</h3>
{% if logs %}
    <div style="overflow-x: auto;">
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>타임스탬프 (UTC)</th>
                <th>사용자</th>
                <th>작업</th>
                <th>클라이언트 IP</th>
                <th>리소스 타입</th>
                <th>리소스 이름</th>
                <th>상태</th>
                <th>상세 정보</th>
            </tr>
        </thead>
        <tbody>
            {% for log_entry in logs %}
            <tr>
                <td>{{ log_entry.id }}</td>
                <td>{{ log_entry.timestamp.strftime('%Y-%m-%d %H:%M:%S') if log_entry.timestamp else '' }}</td>
                <td>{{ log_entry.username or 'N/A' }}</td>
                <td>{{ log_entry.action }}</td>
                <td>{{ log_entry.client_ip or 'N/A' }}</td>
                <td>{{ log_entry.resource_type or 'N/A' }}</td>
                <td>{{ log_entry.resource_name or 'N/A' }}</td>
                <td>
                    <span class="status-text status-{{ log_entry.status.lower() if log_entry.status else 'unknown' }}">
                        {{ log_entry.status or 'UNKNOWN' }}
                    </span>
                </td>
                <td>
                    {% if log_entry.details %}
                        <button class="button view-details-btn" data-details='{{ log_entry.details | tojson }}'>상세 보기</button>
                    {% else %}
                        N/A
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    <p>현재 {{ logs | length }}개 로그 표시 (오프셋: {{ current_filters.offset }}, 제한: {{ current_filters.limit }})</p>

{% else %}
    <p>선택한 조건에 맞는 감사 로그가 없습니다.</p>
{% endif %}

<p style="margin-top: 20px;"><a href="{{ url_for('read_root_web') }}">&laquo; 홈으로 돌아가기</a></p>

{# Modal Structure #}
<div id="auditDetailsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span class="modal-close-button">&times;</span>
      <h3>상세 정보</h3>
    </div>
    <div class="modal-body">
      <pre id="modalDetailsContent"></pre>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    var modal = document.getElementById("auditDetailsModal");
    var closeModalButton = modal.querySelector(".modal-close-button");
    var modalDetailsPre = document.getElementById("modalDetailsContent");
    var detailButtons = document.querySelectorAll(".view-details-btn");

    detailButtons.forEach(function(btn) {
        btn.addEventListener('click', function() {
            var detailsJsonString = this.getAttribute("data-details");
            if (detailsJsonString) {
                try {
                    // HTML 속성에서 읽은 JSON 문자열을 객체로 파싱
                    var detailsObject = JSON.parse(detailsJsonString);
                    // 모달에 표시하기 위해 다시 예쁘게 포맷된 JSON 문자열로 변환
                    modalDetailsPre.textContent = JSON.stringify(detailsObject, null, 2);
                } catch (e) {
                    console.error("Error parsing details JSON: ", e);
                    modalDetailsPre.textContent = "상세 정보를 표시하는 중 오류가 발생했습니다. 원본 데이터: " + detailsJsonString;
                }
            } else {
                modalDetailsPre.textContent = "표시할 상세 정보가 없습니다.";
            }
            modal.style.display = "block";
        });
    });

    if (closeModalButton) {
        closeModalButton.onclick = function() {
            modal.style.display = "none";
        }
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
});
</script>

{% endblock %}
